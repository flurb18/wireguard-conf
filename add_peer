#!/bin/bash

ROOT_DIR=$(realpath $(dirname "$0"))
if [ ! -f ${ROOT_DIR}/config.env ]; then
    echo "Create a config file at ${ROOT_DIR}/config.env"
    echo "Starting config file found at ${ROOT_DIR}/config.env.example"
    exit 1
fi
source ${ROOT_DIR}/config.env

usage() {
    cat <<EOF
Usage: $0 peername [ip]
EOF
}

if [ $# -lt 1 ]; then
    usage
    exit 1
fi

if [ $# == 1 ]; then
    peername=$1
    ip=$(${ROOT_DIR}/list_ips --avail | head -n 1)
else
    peername=$1
    ip=$2
fi
    
unset FOUND
for ip_avail in $(${ROOT_DIR}/list_ips --avail); do
    if [ $ip == $ip_avail ]; then
        FOUND=true
        break
    fi
done
if [ ! $FOUND ]; then
    echo "Invalid ip!"
    exit 1
fi

unset FOUND
for peername_used in $(${ROOT_DIR}/list_peernames); do
    if [ $peername == $peername_used ]; then
        FOUND=true
        break
    fi
done
if [ $FOUND ]; then
    echo "Peername in use!"
    exit 1
fi

iprange="${ip}/32"
psk=$(wg genpsk)
key=$(wg genkey)
pub=$(echo "$key" | wg pubkey)
hub_pub=$(grep '^PrivateKey' ${ROOT_DIR}/${wgifname}.conf | cut -d= -f2- | xargs | wg pubkey)

cp ${ROOT_DIR}/${wgifname}.conf ${ROOT_DIR}/${wgifname}.conf.bck

cat >> ${ROOT_DIR}/${wgifname}.conf <<EOF
[Peer]       # ${peername}
PublicKey    = ${pub}
PresharedKey = ${psk}
AllowedIPs   = ${iprange}

EOF

echo "Changes made to ${wgifname}.conf, backed up original at ${ROOT_DIR}/${wgifname}.conf.bck"

CONFDEST="${ROOT_DIR}/userconfs-${wgifname}/${peername}.conf"

cat > $CONFDEST <<EOF
[Interface]
PrivateKey      = ${key}
Address         = ${iprange}
EOF

if [[ -n $dns ]]; then
    cat >> $CONFDEST <<EOF
DNS             = ${dns}
EOF
fi

cat >> $CONFDEST <<EOF

[Peer]
PublicKey       = ${hub_pub}
PresharedKey    = ${psk}
AllowedIPs      = ${defaultallowedips}
Endpoint        = ${endpoint}
EOF

chmod 600 $CONFDEST

echo "New config at ${CONFDEST}"
